[[!meta title="Puppet"]]

The puppet master is [[servers/lightning]].

# Puppeting New Machines
The **production** puppet configuration files are in */etc/puppet*.
When puppeting new machines, you should do so in your own puppet environment. Puppet environments are in */opt/puppet/env* on the puppet master.

## Creating Your Puppet Environment
To create your own puppet environment, do:

    kedo@lightning:/opt/puppet/env$ sudo git clone /etc/puppet kedo
    kedo@lightning:/opt/puppet/env$ sudo chown -R kedo:ocfstaff kedo

You can commit changes to your environment as you work. When you're done, ask an SM to pull from your environment into the production */etc/puppet* repo.

## Puppeting Preseeded Debian Install

### First Things First - Change Root Password
After running the PXE-booted Debian installer on a new VM on *hal*, basic system settings will be pre-installed, such as the default root password. **Change the root password as soon as possible after the Debian installer finishes.** This VM is called the puppet agent.

### Change the Agent's Puppet Environment
Next, edit the the puppet config file on the agent */etc/puppet/puppet.conf* to tell it to use your personal environment. Add a line like:

    environment = envname

to the config file to make it use the */opt/puppet/env/envname* environment on the puppet master.


### Sign the Agent's Certificate
By now, the agent has sent an SSL certificate to the master. The master needs to sign this certificate. On the puppet master, run:

    kedo@lightning:/$ sudo puppet cert list --all
    + avalanche.int.ocf.berkeley.edu    (C7:E4:4D:09:72:1D:52:61:2B:49:6E:AB:83:55:97:12)
    [...]
    + surge.ocf.berkeley.edu            (45:C2:3A:91:AF:8F:47:07:8A:6B:5D:E3:FE:64:B3:B9)
    

to list all certificates. The hostnames with a "+" in front of them have already been signed. You will see the hostname of the new puppet agent. If the puppet master has already signed the a certificate for the machine (which might happen if you're re-installing a machine), run the following to delete the old signing:

    kedo@lightning:/$ sudo puppet cert clean fqdn hostname.int.ocf.berkeley.edu

If the puppet master hasn't already signed a certificate for the new agent's hostname, you can sign it:

    kedo@lightning:/$ sudo puppet sign hostname.int.ocf.berkeley.edu

### Add Principals and Set Root Password (Again)
Run *gen-principals.sh* and *gen-rootpw.sh* in */opt/puppet/scripts* on the puppet master to generate the private root password hash and Kerberos host principal for the agent.

### Restart Puppet on the Agent
Puppet runs and does its thing every 30 minutes. If you make changes and want it to sync faster, just restart the puppet daemon on the agent.

    kedo@blight:/$ sudo /etc/init.d/puppet restart

The agent will log to */var/log/daemon.log*.
